#!/usr/bin/env bash
set -euo pipefail
cd $(dirname "${BASH_SOURCE[0]}")
source constants

if [[ $(id -u) != 0 ]]; then
    echo "Please run this script as a root user"
    exit 2
fi

if [[ $# != 1 ]]; then
    echo "Usage: $0 <luks encrypted drive>"
    exit 1
fi

SSH_PORT=2200
HOSTNAME="plex-uflix"
PLEX_DEVICE="$1"
PLEX_MAPPED="uflix-data-$$"
PLEX_MOUNT="/mnt/$PLEX_MAPPED"
PLEX_BLOCK_MAPPED="/dev/mapper/$PLEX_MAPPED"

cleanup() {
    if [[ -d $PLEX_MOUNT ]]; then
        umount $PLEX_MOUNT
        rmdir $PLEX_MOUNT
    fi
    if [[ -b $PLEX_BLOCK_MAPPED ]]; then
        cryptsetup remove $PLEX_MAPPED
    fi
}

trap cleanup INT TERM EXIT

# make sure dm-crypt & dm-mod module is loaded
modprobe dm-crypt
modprobe dm-mod

# Open the encrypted drive
cryptsetup open --type luks $PLEX_DEVICE $PLEX_MAPPED
mkdir -p $PLEX_MOUNT
mount $PLEX_BLOCK_MAPPED $PLEX_MOUNT

docker run \
    --rm \
    -h $HOSTNAME \
    -p $SSH_PORT:22 \
    -v $PLEX_MOUNT:$PLEX_HOME \
    -p 32400:32400 \
    -p 32400:32400/udp \
    -p 32469:32469 \
    -p 32469:32469/udp \
    -p 5353:5353/udp \
    -p 1900:1900/udp \
    uflix/main
